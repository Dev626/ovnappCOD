<div class="container-fluid">
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">
        <i class="fas fa-file-alt mr-2"></i>Documentos
      </h6>
      <div class="btn-header-card">
        <!-- <button class="btn btn-outline-secondary btn-sm mr-1" (click)="openFilterModal()">
                    <i class="fas fa-filter fa-sm"></i> Filtrar
                </button> -->
        <button class="btn btn-primary mr-1" (click)="openNewDocumentModal()">
          <i class="fas fa-plus fa-sm"></i> Nuevo Documento
        </button>
      </div>
    </div>

    <div class="card-body">
      <!-- <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                        <input type="text" class="form-control" placeholder="Buscar documentos..."
                               [(ngModel)]="searchTerm" (keyup)="filterDocuments()">
                    </div>
                </div>

            </div> -->

      <div class="table-responsive">
        <table class="table table-bordered dataTable" cellspacing="0">
          <thead>
            <tr role="row">
              <th scope="col" style="width: 1rem" class="text-center">
                <i
                  title="Acciones"
                  class="text-muted text-size-10 fas fa-cogs"
                ></i>
              </th>
              <th>Documento</th>
              <!-- <th>Tipo</th>
                            <th>Archivo</th> -->
              <th>Usuario</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of ldocuments">
              <td class="text-center">
                <!-- <a class="text-size-10 text-success"
                  ><i title="¡Editar!" class="fas fas fa-edit"></i
                ></a> -->
                <div class="btn-group" role="group">
                  <!-- Botón de vista previa solo para PDFs -->
                  <button
                    class="btn btn-sm btn-primary mr-2"
                    (click)="previewPDF(mapToDocumentModel(item))"
                    [disabled]="getFileExtension(item.file_name) !== 'pdf'"
                    [title]="getFileExtension(item.file_name) === 'pdf' ? 'Previsualizar PDF' : 'Solo PDFs'"
                  >
                    <i class="fas fa-eye fa-xs"></i>
                  </button>

                  <!-- Botón de descarga -->
                  <button
                    class="btn btn-sm btn-info mr-2"
                    (click)="saveFile(item.document_id)"
                    title="Descargar archivo"
                  >
                    <i class="fas fa-download fa-xs"></i>
                  </button>
                  <!-- Botón de editar -->
                  <button
                  *ngIf="cse.tieneRol([ccs.config.rol_kudo.submitter])"
                    class="btn btn-sm btn-success mr-2"
                    (click)="openEditDocumentModal(item)"
                  >
                    <i title="¡Editar!" class="fas fa-edit"></i>
                  </button>
                  <!-- Botón de aprobar -->
                  <button
    class="btn btn-sm btn-success"
    (click)="approveDocument(item, $event)"

    *ngIf="cse.tieneRol([ccs.config.rol_kudo.approver]) && !cse.tieneRol([ccs.config.rol_kudo.submitter])"
>
    <i title="Aprobar" class="fas fa-check"></i>
</button>
                  <!-- Botón de remover -->
                  <button
                  *ngIf="cse.tieneRol([ccs.config.rol_kudo.submitter])"
                      class="btn btn-sm btn-danger"
                      (click)="removeDocument(item, $event)"
                  >
                    <i title="Remover" class="fas fa-trash"></i>
                  </button>

                  <!-- Botón de eliminar -->
                  <!-- <button
                    class="btn btn-sm btn-danger"
                    title="Eliminar documento"
                  >
                    <i class="fas fa-trash fa-xs"></i>
                  </button> -->
                </div>
              </td>
              <td>
                <div><strong>Titulo:</strong> {{ item.title }}</div>
                <div><strong>Tipo:</strong> {{ item.document_type_desc }}</div>
                <div><strong>Archivo:</strong> {{ item.file_name }}</div>
              </td>
              <!-- <td>{{item.title}}</td>
                          <td>{{item.document_type_desc}}</td>
                          <td>{{item.file_name}}</td> -->
              <!-- <td>{{item.comment}}</td> -->
              <td>
                <div>{{ item.created_by_desc }}</div>
                <div>
                  <strong>Registrado:</strong> {{ item.created_at | ohDate:
                  cse.config.formatShortDateTime }}
                </div>
              </td>
              <td>
                <span
                  [ngClass]="{
                  'badge-success': item.status === 1,
                  'badge-warning': item.status === 0,
                  'badge-danger': item.status === 2
                    }"
                  class="badge"
                >
                  {{item.status_desc}}
                </span>
              </td>

              <!-- <td>{{item.created_by_desc}}</td>
                          <td>{{item.created_at |  ohDate: cse.config.formatShortDateTime}}</td> -->
              <!-- <td>{{item.updated_by_desc}}</td>
                          <td>{{item.updated_at |  ohDate: cse.config.formatShortDateTime}}</td> -->
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Filtros -->
<ng-template #modalDocumentFilter let-c="close" let-d="dismiss">
  <div class="modal-header">
    <span class="h5 m-0">
      <i class="fa fa-filter mr-1"></i>Filtrar Documentos
    </span>
    <a
      href="#"
      class="close text-dark"
      aria-label="Close"
      (click)="$event.preventDefault(); d('Cross click')"
    >
      <i class="fas fa-times fa-xs"></i>
    </a>
  </div>
  <div class="modal-body">
    <form #frmFiltroDocument="ngForm" class="form-enable">
      <div class="form-group row">
        <label class="col-sm-3 col-form-label">Título</label>
        <div class="col-sm-9">
          <input
            name="inp_title"
            class="form-control"
            type="text"
            [(ngModel)]="filterData.title"
            placeholder="Buscar por título..."
            (keyup.enter)="c('doFilter')"
          />
        </div>
      </div>

      <div class="form-group row">
        <label class="col-sm-3 col-form-label">Tipo</label>
        <div class="col-sm-9">
          <select
            name="inp_type"
            class="form-control"
            [(ngModel)]="filterData.type"
          >
            <option value="">Todos los tipos</option>
            <option value="carta">Carta</option>
            <option value="acta">Acta</option>
            <option value="contrato">Contrato</option>
            <option value="informe">Informe</option>
            <option value="oficio">Oficio</option>
            <option value="memo">Memorándum</option>
            <option value="certificado">Certificado</option>
            <option value="otro">Otro</option>
          </select>
        </div>
      </div>

      <div class="form-group row">
        <label class="col-sm-3 col-form-label">Extensión</label>
        <div class="col-sm-9">
          <div
            class="btn-group btn-group-toggle"
            ngbRadioGroup
            name="inp_extension"
          >
            <label ngbButtonLabel class="btn-outline-secondary btn-sm">
              <input
                ngbButton
                type="radio"
                [value]="null"
                [(ngModel)]="filterData.extension"
              />
              Todos
            </label>
            <label ngbButtonLabel class="btn-outline-danger btn-sm">
              <input
                ngbButton
                type="radio"
                value="pdf"
                [(ngModel)]="filterData.extension"
              />
              PDF
            </label>
            <label ngbButtonLabel class="btn-outline-primary btn-sm">
              <input
                ngbButton
                type="radio"
                value="doc"
                [(ngModel)]="filterData.extension"
              />
              DOC
            </label>
            <label ngbButtonLabel class="btn-outline-success btn-sm">
              <input
                ngbButton
                type="radio"
                value="xls"
                [(ngModel)]="filterData.extension"
              />
              XLS
            </label>
          </div>
        </div>
      </div>

      <div class="form-group row">
        <label class="col-sm-3 col-form-label">Fecha</label>
        <div class="col-sm-4">
          <input
            name="inp_date_from"
            class="form-control"
            type="date"
            [(ngModel)]="filterData.dateFrom"
            placeholder="Desde"
          />
        </div>
        <div class="col-sm-1 text-center align-self-center">
          <small class="text-muted">hasta</small>
        </div>
        <div class="col-sm-4">
          <input
            name="inp_date_to"
            class="form-control"
            type="date"
            [(ngModel)]="filterData.dateTo"
            placeholder="Hasta"
          />
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="clearFilters(); c('clearFilter')"
    >
      <i class="fa fa-times mr-1"></i>Limpiar
    </button>
    <button
      type="submit"
      class="btn btn-outline-primary"
      (click)="c('doFilter')"
    >
      <i aria-hidden="true" class="fa fa-filter mr-1"></i>Aplicar Filtros
    </button>
  </div>
</ng-template>

<!-- Modal para Nuevo Documento -->
<ng-template #modalNewDocument let-c="close" let-d="dismiss">
  <div class="modal-header">
    <span class="h5 m-0">
      <i
        [class]="newDocument.document_id ? 'fas fa-edit mr-1' : 'fas fa-file-plus mr-1'"
      ></i>
      {{ newDocument.document_id ? 'Editar Documento' : 'Nuevo Documento' }}
    </span>
    <a
      href="#"
      class="close text-dark"
      aria-label="Close"
      (click)="$event.preventDefault(); d('Cross click')"
    >
      <i class="fas fa-times fa-xs"></i>
    </a>
  </div>
  <div class="modal-body">
    <form #frmNewDocument="ngForm" class="form-enable">
      <div class="form-group">
        <label class="form-label font-weight-bold"
          >Título del Documento <span class="text-danger">*</span></label
        >
        <input
          name="inp_document_title"
          class="form-control"
          type="text"
          [(ngModel)]="newDocument.title"
          placeholder="Ingrese el título del documento"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label font-weight-bold"
          >Tipo de Documento <span class="text-danger">*</span></label
        >
        <oh-predictive-text
          [searchBy]="['descripcion']"
          [return]="'catalogo_id'"
          [(value)]="newDocument.type"
          [data]="catalogo"
          [form]="frmNewDocument"
          [name]="'inp_type'"
          [required]="true"
          [openOnClick]="true"
          placeholder="Seleccione tipo documento..."
        ></oh-predictive-text>
      </div>

      <!-- Campo de Estado - Solo visible en modo EDICIÓN -->
      <!-- <div class="form-group" *ngIf="newDocument.document_id && cse.tieneRol([ccs.config.rol_kudo.approver])">
        <label class="form-label font-weight-bold">Estado</label>
        <select
          name="inp_status"
          class="form-control"
          [(ngModel)]="newDocument.status"
        >
          <option [value]="0">Enviado</option>
          <option [value]="1">Aprobado</option>
          <option [value]="2">Removido</option>
        </select>
        <small class="form-text text-muted">
          Puede cambiar el estado del documento desde aquí
        </small>
      </div> -->

      <div class="form-group">
        <label class="form-label font-weight-bold">
          Archivo
          <span class="text-danger" *ngIf="!newDocument.document_id">*</span>
        </label>

        <!-- Mostrar archivo actual si es edición -->
        <div
          *ngIf="newDocument.document_id && selectedFileName"
          class="alert alert-info mb-2"
        >
          <i class="fas fa-file mr-1"></i>
          <strong>Archivo actual:</strong> {{ selectedFileName }}
        </div>

        <div class="custom-file">
          <input
            type="file"
            class="custom-file-input"
            id="customFile"
            (change)="onFileSelected($event)"
            accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif"
          />
          <label class="custom-file-label" for="customFile">
            {{ selectedFile ? selectedFile.name : (newDocument.document_id ?
            'Cambiar archivo (opcional)' : 'Seleccionar archivo...') }}
          </label>
        </div>
        <small class="form-text text-muted">
          <span *ngIf="!newDocument.document_id"
            >Formatos admitidos: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, GIF (Máx:
            10MB)</span
          >
          <span *ngIf="newDocument.document_id"
            >Seleccione un archivo solo si desea reemplazar el actual. Formatos
            admitidos: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, GIF (Máx:
            10MB)</span
          >
        </small>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="d('cancel')">
      <i class="fa fa-times mr-1"></i>Cancelar
    </button>
    <button
      type="submit"
      class="btn btn-primary"
      [disabled]="!frmNewDocument.form.valid || (!selectedFile && !newDocument.document_id)"
      (click)="newDocument.document_id ? updateDocument() : saveDocument(); c(newDocument.document_id ? 'update' : 'save')"
    >
      <i
        [class]="newDocument.document_id ? 'fas fa-check mr-1' : 'fas fa-save mr-1'"
      ></i>
      {{ newDocument.document_id ? 'Actualizar Documento' : 'Guardar Documento'
      }}
    </button>
  </div>
</ng-template>

<!-- Modal para Vista Previa PDF -->
<ng-template #modalPDFPreview let-modal>
  <div class="modal-header">
    <h4 class="modal-title">
      Previsualización: {{ previewDocument?.fileName || 'Documento' }}
    </h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Cerrar"
      (click)="closePdfPreview()"
    ></button>
  </div>

  <div class="modal-body p-0" style="height: 80vh">
    <!-- <iframe
      *ngIf="pdfPreviewUrl"
      [src]="pdfPreviewUrl"
      width="100%"
      height="100%"
      style="border: none;"
      title="Vista previa del PDF">
    </iframe> -->
    <object
      *ngIf="pdfPreviewUrl"
      [data]="pdfPreviewUrl"
      type="application/pdf"
      width="100%"
      height="100%"
    >
      <!-- <p>
        El visor PDF no es compatible en este dispositivo. <a [href]="pdfPreviewUrl" target="_blank">Descargar PDF</a>
      </p> -->
    </object>

    <div
      *ngIf="!pdfPreviewUrl"
      class="d-flex justify-content-center align-items-center h-100"
    >
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closePdfPreview()">
      Cerrar
    </button>
  </div>
</ng-template>
